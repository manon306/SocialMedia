@* _GetAllPosts *@
@model List<PostVm>
@{
    ViewData["Title"] = "Posts";
}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">Posts </h3>
                <span class="badge bg-accent rounded-pill">@Model.Count Post</span>
            </div>

            @foreach (var post in Model)
            {
                <div class="card post-card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <img src="https://via.placeholder.com/48" class="rounded-circle user-avatar me-3" alt="Profile Image">
                            <div class="flex-grow-1">
                                <div class="user-name">عمر أحمد</div>
                                <div class="user-title">مطور واجهات أمامية</div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <form asp-controller="Post" asp-action="ToggleSavedPosts" method="post" style="display:inline;">
                                            <input type="hidden" name="id" value="@post.ID" />
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-bookmark-check me-2"></i>Save
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form asp-controller="Post" asp-action="ToggleArchivePosts" method="post" style="display:inline;">
                                            <input type="hidden" name="id" value="@post.ID" />
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-bookmark-check me-2"></i>Archive
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <a asp-action="UpdatePost" asp-route-id="@post.ID" asp-controller="Post" class="btn btn-sm btn-warning">Edit</a>
                                    </li>
                                    
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-link-45deg me-2"></i>Copy Link</a></li>
                                    <li>
                                        <form asp-controller="Post" asp-action="DeletePost" method="post" style="display:inline;">
                                            <input type="hidden" name="id" value="@post.ID" />
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-trash me-2"></i> Delete
                                            </button>
                                        </form>
                                    </li>
                                    
                                    
                                    
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <p class="post-content">@post.Content</p>

                        @if (!string.IsNullOrEmpty(post.Image))
                        {
                            <img src="~/Images/@post.Image" class="post-image" alt="Image" />
                        }

                        @if (!string.IsNullOrEmpty(post.Videos))
                        {
                            <video controls class="post-video">
                                <source src="~/Videos/@post.Videos" type="video/mp4" />
                                Not Allowed
                            </video>
                        }

                        <div class="engagement-stats">
                            <span><i class="bi bi-heart-fill text-danger me-1"></i> 245 Like</span>
                            <span><i class="bi bi-chat-fill text-info me-1"></i> 43 Comments</span>
                            <span><i class="bi bi-share-fill text-success me-1"></i> 12 Share</span>
                        </div>

                        <div class="post-actions">
                            <button class="btn action-btn">
                                <i class="bi bi-heart"></i> Like
                            </button>
                            <button class="btn action-btn">
                                <i class="bi bi-chat"></i> Comment
                            </button>
                            <button class="btn action-btn">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>

                        <div class="d-flex align-items-center mt-3">
                            <img src="https://via.placeholder.com/40" class="rounded-circle me-2 border" width="40" height="40" alt="Profile Image">
                            <div class="flex-grow-1">
                                <form asp-controller="Comment" asp-action="AddComment" method="post" class="d-flex">
                                    <input type="hidden" name="PostID" value="@post.ID" />
                                    <input type="text" name="Content" class="form-control rounded-pill me-2" placeholder="Write a comment..." aria-label="Add Comment">
                                    <button class="btn btn-primary rounded-pill" type="submit">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- الكومنتات -->
                        <div class="comments-container mt-3 p-2  rounded text-black" id="comments-@post.ID">
                            
                            <!-- الكومنتات هتيجي هنا -->
                        </div>



                    </div>
                </div>
            }

            @if (Model.Count == 0)
            {
                <div class="text-center py-5">
                    <i class="bi bi-bookmark-x" style="font-size: 3rem; color: var(--muted-text);"></i>
                    <h4 class="mt-3">No Posts yet</h4>
                </div>
            }
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var currentUser = '@User.Identity.Name';
</script>

<script>
function loadComments(postId) {
    $.ajax({
        url: `/Comment/GetAllComments?id=${postId}`,
        type: "GET",
        success: function (data) {
            let container = $(`#comments-${postId}`);
            container.empty();
            if (data && data.length > 0) {
                data.forEach(c => {
                    container.append(`
                            <div class="d-flex mb-3" id="comment-${c.id}">
        <div class="flex-grow-1">
            <div class="p-2 bg-white rounded shadow-sm border" id="comment-text-${c.id}">
                <strong class="d-block">${currentUser}</strong>
                <span id="comment-content-${c.id}">${c.content}</span>
            </div>

            <!-- فورم التعديل -->
            <form class="edit-comment-form d-none mt-2" data-id="${c.id}">
                <input type="hidden" name="ID" value="${c.id}" />
                <input type="text" name="Content" class="form-control mb-2" value="${c.content}" />
                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                <button type="button" class="btn btn-sm btn-secondary cancel-edit" data-id="${c.id}">Cancel</button>
            </form>

            <div class="d-flex align-items-center mt-1 small text-muted">
                <button class="btn btn-link btn-sm p-0 me-3 text-decoration-none">Like</button>
                <button class="btn btn-link btn-sm p-0 me-3 text-decoration-none">Reply</button>
                <button class="btn btn-link btn-sm p-0 me-3 text-decoration-none edit-btn" data-id="${c.id}">Edit</button>
                <span>· Just now</span>
            </div>
                <button type="button" class="btn btn-link text-danger delete-comment-btn" data-id="${c.id}">
        <i class="bi bi-trash me-2"></i> Delete
    </button>


            <div class="replies mt-2 ps-4 border-start" id="replies-${c.id}">
                    <form class="reply-form d-flex mt-2" data-commentid="${c.id}">
                        <input type="hidden" name="ParentCommentID" value="${c.id}" />
                        <input type="text" name="Content" class="form-control form-control-sm rounded-pill me-2" placeholder="Write a reply..." />
                        <button type="submit" class="btn btn-sm btn-primary rounded-pill">
                            <i class="bi bi-send"></i>
                        </button>
                    </form>

            </div>
    </div>
</div>
                    `);
                        loadReplies(c.id);
                });
            } else {
                container.append(`<p class="text-muted">No comments yet.</p>`);
            }
        },
        error: function () {
            console.log("Error loading comments.");
        }
        });
    }
    // إظهار الفورم عند الضغط على Edit
    $(document).on("click", ".edit-btn", function () {
        let id = $(this).data("id");
        $(`#comment-text-${id}`).hide();
        $(`form[data-id='${id}']`).removeClass("d-none");
    });

    // إلغاء التعديل
    $(document).on("click", ".cancel-edit", function () {
        let id = $(this).data("id");
        $(`#comment-text-${id}`).show();
        $(`form[data-id='${id}']`).addClass("d-none");
    });

    // إرسال التعديل
    $(document).on("submit", ".edit-comment-form", function (e) {
        e.preventDefault();
    let form = $(this);
    let id = form.data("id");
    let content = form.find("input[name='Content']").val();

    $.ajax({
        url: "/Comment/UpdateComment",
            type: "POST",
            data: {ID: id, Content: content },
            success: function () {
                $(`#comment-content-${id}`).text(content);
                form.addClass("d-none");
                    $(`#comment-text-${id}`).show();
                    },
            error: function () {
                alert("Error updating comment");
}
                });
    });
    $(document).on("click", ".delete-comment-btn", function () {
        let id = $(this).data("id");

    $.ajax({
        url: "/Comment/DeleteComment",
        type: "POST",
        data: {Id: id, DeletedBy: currentUser },
        success: function (res) {
                    if (res.success) {
                        $(`#comment-${id}`).remove();
                                } else {
                        alert(res.message || "Error deleting comment");
                                }
                    },
        error: function () {
            alert("Server error while deleting comment");
                }
            });
    });
        // إرسال رد
    $(document).on("submit", ".reply-form", function (e) {
        e.preventDefault();

        let form = $(this);
        let commentId = form.find("input[name='ParentCommentID']").val();
        let content = form.find("input[name='Content']").val();

        $.ajax({
            url: "/Reply/AddComment",   // زي ما عاملتي في الـ Controller
            type: "POST",
            data: { ParentCommentID: commentId, Content: content },
            success: function (res) {
                if (res.success) {
                    // ضيفي الرد في منطقة replies
                    $(`#replies-${commentId}`).append(`
                        <div class="reply bg-light p-2 rounded mb-1">
                            <strong>${currentUser}</strong>: ${content}

                        </div>
                    `);
                    form.find("input[name='Content']").val(""); // امسحي التكست
                } else {
                    alert(res.message || "Error adding reply");
                }
            },
            error: function () {
                alert("Server error while adding reply");
            }
        });
    });

        function loadReplies(commentId) {
        $.ajax({
            url: `/Reply/GetAllComments?id=${commentId}`, // نفس الشكل عندك
            type: "GET",
            success: function (data) {
                let container = $(`#replies-${commentId}`);
                container.find(".reply").remove(); // امسح القديم
                if (data && data.length > 0) {
                    data.forEach(r => {
                        container.append(`
                            <div class="reply bg-light p-2 rounded mb-1">
                                <strong>${currentUser}</strong>: ${r.content}
                            </div>
                        `);
                    });
                }
            },
            error: function () {
                console.log("Error loading replies.");
            }
        });
    }


    $(document).ready(function () {
        @foreach (var post in Model)
    {
            <text>loadComments(@post.ID);</text>
    }
    });
</script>





















